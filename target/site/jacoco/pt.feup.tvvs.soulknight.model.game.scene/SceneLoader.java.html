<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SceneLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Soul Knight</a> &gt; <a href="index.source.html" class="el_package">pt.feup.tvvs.soulknight.model.game.scene</a> &gt; <span class="el_source">SceneLoader.java</span></div><h1>SceneLoader.java</h1><pre class="source lang-java linenums">package pt.feup.tvvs.soulknight.model.game.scene;

import pt.feup.tvvs.soulknight.model.dataStructs.Position;
import pt.feup.tvvs.soulknight.model.game.elements.collectables.Collectables;
import pt.feup.tvvs.soulknight.model.game.elements.collectables.OrbFactory;
import pt.feup.tvvs.soulknight.model.game.elements.Element;
import pt.feup.tvvs.soulknight.model.game.elements.knight.Knight;
import pt.feup.tvvs.soulknight.model.game.elements.particle.Particle;
import pt.feup.tvvs.soulknight.model.game.elements.particle.RainParticle;
import pt.feup.tvvs.soulknight.model.game.elements.Spike;
import pt.feup.tvvs.soulknight.model.game.elements.Tree;
import pt.feup.tvvs.soulknight.model.game.elements.enemies.Enemies;
import pt.feup.tvvs.soulknight.model.game.elements.enemies.MonsterFactory;
import pt.feup.tvvs.soulknight.model.game.elements.rocks.Rock;
import pt.feup.tvvs.soulknight.model.game.elements.tile.Tile;
import com.googlecode.lanterna.TextColor;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

import static java.lang.Character.isLetterOrDigit;
import static java.lang.Character.isSpaceChar;
import static java.nio.charset.StandardCharsets.UTF_8;

public class SceneLoader {
    private final List&lt;String&gt; lines;
    private final int sceneID;

<span class="fc" id="L38">    private final int TILE_SIZE = 8;</span>

<span class="fc" id="L40">    public SceneLoader(int id) throws IOException {</span>
<span class="fc" id="L41">        this.sceneID = id;</span>
<span class="fc" id="L42">        URL resource = getClass().getClassLoader().getResource(&quot;levels/level&quot; + id + &quot;.lvl&quot;);</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        if (resource == null){</span>
<span class="fc" id="L44">            throw new FileNotFoundException(&quot;Level file not found!&quot;);</span>
        }
<span class="fc" id="L46">        Path path = Paths.get(new File(resource.getFile()).toURI());</span>
<span class="fc" id="L47">        BufferedReader br = Files.newBufferedReader(path, UTF_8);</span>


<span class="fc" id="L50">        lines = readLines(br);</span>
<span class="fc" id="L51">    }</span>

    private List&lt;String&gt; readLines(BufferedReader br) throws IOException {
<span class="fc" id="L54">        List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">        for (String line; (line = br.readLine()) != null; )</span>
<span class="fc" id="L56">            lines.add(line);</span>
<span class="fc" id="L57">        return lines;</span>
    }

    public Scene createScene(Knight knight) {
<span class="fc" id="L61">        Scene scene = new Scene(230, 130, sceneID);</span>

<span class="fc" id="L63">        scene.setPlayer(createPlayer(scene, knight));</span>
<span class="fc" id="L64">        scene.setStartPosition(scene.getPlayer().getPosition());</span>
<span class="fc" id="L65">        scene.setMap(createMap(scene));</span>
<span class="fc" id="L66">        scene.setTiles(createWalls(scene));</span>

<span class="fc" id="L68">        scene.setSpikes(createSpikes(scene));</span>
<span class="fc" id="L69">        scene.setTrees(createTrees(scene));</span>
<span class="fc" id="L70">        scene.setRocks(createRocks(scene));</span>
<span class="fc" id="L71">        scene.setOrbs(createOrbs(scene));</span>

<span class="fc" id="L73">        scene.setMonsters(createMonsters(scene));</span>
<span class="fc" id="L74">        scene.setParticles(createParticles(15, scene));</span>


<span class="fc" id="L77">        return scene;</span>
    }

    public void setOrbs(Scene scene) {
<span class="fc" id="L81">        scene.setOrbs(createOrbs(scene));</span>
<span class="fc" id="L82">    }</span>

    protected int getWidth() {
<span class="fc" id="L85">        int width = 0;</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        for (String line : lines)</span>
<span class="fc" id="L87">            width = Math.max(width, line.length());</span>
<span class="fc" id="L88">        return width;</span>
    }

    protected int getHeight() {
<span class="fc" id="L92">        return lines.size();</span>
    }

    private Element[][] createMap(Scene scene) {
<span class="fc" id="L96">        Element[][] map = new Element[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L99">            String line = lines.get(y);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="pc bpc" id="L101" title="1 of 8 branches missed.">                if (line.charAt(x) == 'x' || line.charAt(x) == 'M' || line.charAt(x) == 'G'|| line.charAt(x) == 'L') {</span>
<span class="fc" id="L102">                    map[y][x] = new Tile(x * TILE_SIZE, y * TILE_SIZE, line.charAt(x));</span>
                }
<span class="fc bfc" id="L104" title="All 2 branches covered.">                else if (line.charAt(x) == 'u') {</span>
<span class="fc" id="L105">                    scene.setEndPosition(new Position(x*TILE_SIZE,y*TILE_SIZE));</span>
                }
                else
<span class="fc" id="L108">                    map[y][x] = null;</span>
            }
        }

<span class="fc" id="L112">        return map;</span>
    }

    private Tile[][] createWalls(Scene scene) {
<span class="fc" id="L116">        Tile[][] walls = new Tile[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L119">            String line = lines.get(y);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="pc bpc" id="L121" title="1 of 8 branches missed.">                if (line.charAt(x) == 'x' || line.charAt(x) == 'M' || line.charAt(x) == 'G' || line.charAt(x) == 'L') {</span>
<span class="fc" id="L122">                    walls[y][x] = new Tile(x * TILE_SIZE, y * TILE_SIZE, line.charAt(x));</span>
                }
                else
<span class="fc" id="L125">                    walls[y][x] = null;</span>
            }
        }

<span class="fc" id="L129">        return walls;</span>
    }

    private Spike[][] createSpikes(Scene scene) {
<span class="fc" id="L133">        Spike[][] spikes = new Spike[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L136">            String line = lines.get(y);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="pc bpc" id="L138" title="1 of 6 branches missed.">                if (!isLetterOrDigit(line.charAt(x)) &amp;&amp; !isSpaceChar(line.charAt(x)) &amp;&amp; line.charAt(x) != '*')</span>
<span class="fc" id="L139">                    spikes[y][x] = new Spike(x * TILE_SIZE, y * TILE_SIZE, line.charAt(x));</span>
                else {
<span class="fc" id="L141">                    spikes[y][x] = null;</span>
                }
            }
        }
<span class="fc" id="L145">        return spikes;</span>
    }
    private Tree[][] createTrees(Scene scene) {
<span class="fc" id="L148">        Tree[][] trees = new Tree[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L150" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L151">            String line = lines.get(y);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="fc bfc" id="L153" title="All 4 branches covered.">                if (line.charAt(x) == 't' || line.charAt(x) == 'T')</span>
<span class="fc" id="L154">                    trees[y][x] = new Tree(x * TILE_SIZE, y * TILE_SIZE, line.charAt(x));</span>
                else {
<span class="fc" id="L156">                    trees[y][x] = null;</span>
                }
            }
        }
<span class="fc" id="L160">        return trees;</span>
    }

    private Rock[][] createRocks(Scene scene) {
<span class="fc" id="L164">        Rock[][] rocks = new Rock[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L167">            String line = lines.get(y);</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="fc bfc" id="L169" title="All 4 branches covered.">                if (line.charAt(x) == 'R' || line.charAt(x) == 'r') {</span>
<span class="fc" id="L170">                    rocks[y][x] = new Rock(x * TILE_SIZE, y * TILE_SIZE, line.charAt(x));</span>
                }
            }
        }
<span class="fc" id="L174">        return rocks;</span>
    }


    public Collectables[][] createOrbs(Scene scene) {
<span class="fc" id="L179">        Collectables[][] orbs = new Collectables[scene.getHeight()][scene.getWidth()];</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L182">            String line = lines.get(y);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="fc" id="L184">                char type = line.charAt(x);</span>
<span class="fc" id="L185">                orbs[y][x] = OrbFactory.createOrb(type, x * TILE_SIZE, y * TILE_SIZE);</span>
            }
        }
<span class="fc" id="L188">        return orbs;</span>
    }

    private List&lt;Enemies&gt; createMonsters(Scene scene) {
<span class="fc" id="L192">        List&lt;Enemies&gt; monsters = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L194" title="All 2 branches covered.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L195">            String line = lines.get(y);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="fc" id="L197">                char type = line.charAt(x);</span>
<span class="fc" id="L198">                Enemies monster = MonsterFactory.createMonster(x * TILE_SIZE, y * TILE_SIZE, scene, type);</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">                if (monster != null) {</span>
<span class="fc" id="L200">                    monsters.add(monster);</span>
                }
            }
        }

<span class="fc" id="L205">        return monsters;</span>
    }

    private Knight createPlayer(Scene scene, Knight knight) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        for (int y = 0; y &lt; lines.size(); y++) {</span>
<span class="fc" id="L210">            String line = lines.get(y);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">            for (int x = 0; x &lt; line.length(); x++) {</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">                if (line.charAt(x) == 'P') {</span>
<span class="fc" id="L213">                    knight.setPosition(new Position(x * TILE_SIZE, y * TILE_SIZE - 2));</span>
<span class="fc" id="L214">                    knight.setScene(scene);</span>
<span class="fc" id="L215">                    return knight;</span>
                }
            }
        }
<span class="nc" id="L219">        throw new IllegalStateException(&quot;Knight not found within the level file!&quot;);</span>

    }

    private List&lt;Particle&gt; createParticles(int size, Scene scene) {
<span class="fc" id="L224">        List&lt;Particle&gt; particles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L225">        Random random = new Random();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">        for (int i = 0; i &lt; size; i++) {</span>

<span class="fc" id="L228">            particles.add(new RainParticle(</span>
<span class="fc" id="L229">                    random.nextInt(scene.getWidth()),</span>
<span class="fc" id="L230">                    random.nextInt(scene.getHeight()),</span>
                    new Position(0, 0),
                    new TextColor.RGB(0, 0,
                            //random.nextInt(100, 255)
<span class="fc" id="L234">                            100 + random.nextInt(255 - 100 + 1)</span>
                            )
            ));
        }
<span class="fc" id="L238">        return particles;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>